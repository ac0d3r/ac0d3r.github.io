## AtomicStealer - BrewApp
**Summary**

- **Malware Sample**: [AtomicStealer.zip](https://github.com/objective-see/Malware/blob/main/AtomicStealer.zip)
- **Tag**: `CryptoStealer`
- **Writeup(s)**: 
  - https://alden.io/posts/infostealers-a-brewin/
  - https://www.sentinelone.com/blog/atomic-stealer-threat-actor-spawns-second-variant-of-macos-malware-sold-on-telegram/
  - https://www.malwarebytes.com/blog/threat-intelligence/2023/09/atomic-macos-stealer-delivered-via-malvertising

---

**Analysis**
Extract the BrewApp.dmg file:

```bash
hdiutil attach BrewApp.dmg
cp -R /Volumes/BrewApp ./
hdiutil detach /Volumes/BrewApp
```

![](https://github.com/user-attachments/assets/6c3ee6f3-52fc-4426-9d69-077775cd8b82)

The sample's symbols have been removed, and all strings have been processed:

<img src="https://github.com/user-attachments/assets/8b4807eb-7a27-45d3-98b7-cfb4b620fb7d" width="180px">

The malware calls `system` multiple times. Set a breakpoint on `system` to start debugging:

![](https://github.com/user-attachments/assets/366740a1-792a-4d44-811a-564f2a8a8be0)

`"osascript -e 'tell application "Terminal" to set visible of front window to false'"` This command hides the current window, which may be used for anti-debugging or sample disguise. Let's skip this execution:

![](https://github.com/user-attachments/assets/58e14844-f177-40da-a1ab-8f3012eab6fd)

Next, a temporary directory will be created under `$HOME`:

![](https://github.com/user-attachments/assets/8a76b87c-ae30-4365-a818-30e7c6a58889)

If created successfully, these functions will be executed:

![](https://github.com/user-attachments/assets/5366ca4b-1100-4779-aa7f-aa150bf8900a)

- `sub_100005E30`

Uses `fopen` to create a `Sysinfo.txt` file in the temporary directory just created, which is used to store collected system information:

![](https://github.com/user-attachments/assets/aea07c04-f9fd-4e02-a948-07ef33c07ae4)

It uses these commands to collect system information:
```
- sw_vers
- system_profiler SPHardwareDataType
- system_profiler SPDisplaysDataType
```
![](https://github.com/user-attachments/assets/d7e355fc-98be-40fb-8388-e1f2617f9bf6)

- `sub_1000073E0`

There is a `while` loop that verifies the identity of the local macOS system user using the command `dscl /Local/Default -authonly whoami {password}`. If it fails, a fake window is triggered to obtain the user's password. Upon success, the password is written to the `password-entered` file:

![](https://github.com/user-attachments/assets/3ae7816f-f3d7-4845-9c1b-92d732c732f7)
![](https://github.com/user-attachments/assets/4a6e6321-a745-4661-aef6-f5a979641a0b)
![](https://github.com/user-attachments/assets/81a91914-f3dc-4b52-b42f-81314234097c)
![](https://github.com/user-attachments/assets/18f79567-c4a6-40fb-b294-8dc2dc021bed)

It will then copy the user's `login.keychain-db` file:

![](https://github.com/user-attachments/assets/df859e7d-f407-4b2a-baed-e3848083ac37)

- The other functions seem to do nothing.

- back to `sub_1000124D0`

List installed apps and appends them to the `Sysinfo.txt` file:

![](https://github.com/user-attachments/assets/7838ae2d-a471-46d8-bc76-4779939d9df2)

Copies browser cookies files, data from the Notes app, and files with the following extensions: `{"txt", "docx", "rtf", "doc", "wallet", "keys", "key"}`, etc.

![](https://github.com/user-attachments/assets/00de3816-3553-48c0-933a-578554e5aa5c)

Packages the directory:

![](https://github.com/user-attachments/assets/9a8ace60-ce01-4f58-ba53-a759817dcf42)

Uploads the files to the malware's server:

![image](https://github.com/user-attachments/assets/2e38ba62-7911-4970-b4b2-5eefa823b5ba)

Finally, cleans up the temporary directory and displays an error message to deceive the user:

![image](https://github.com/user-attachments/assets/91f6e13c-f58d-43ed-838b-7a810ebcf417)

## HZRat
**Summary**
- **Malware Sample**: [HZ_RAT.zip](https://github.com/objective-see/Malware/blob/main/HZ_RAT.zip)
- **Tag**: `backdoor`,`DingTalk`,`WeChat`
- **Writeup(s)**: 
  - [HZ Rat backdoor for macOS attacks users of Chinaâ€™s DingTalk and WeChat](https://securelist.com/hz-rat-attacks-wechat-and-dingtalk/113513/)

---

**Analysis**

Extract the pkg file:

```bash
pkgutil --expand OpenVPNConnect.pkg out
```

![extract-pkg2](https://github.com/user-attachments/assets/c41d4b86-065a-40d9-93f9-6ccfa2cd6869)

List `OpenVPN_Connect.pkg/`:

![extract-pkg3](https://github.com/user-attachments/assets/a03cbd25-290e-402c-8d4d-0b2c6a9ef56b)

Check Pkg Scripts:
- `pretinstall`: a macho file
- `postinstall`: set permissions for OpenVPN Connect.app

![extract-postinstall](https://github.com/user-attachments/assets/0e5829e6-5854-447b-aae7-25781653daa6)
  
Extract payload -> `/Applications/OpenVPN Connect.app`:
- `OpenVPN Connect.app`: It's a legal App.
- `exe`: Execute the `init` malicious file in the background and open "OpenVPN Connect.app"
- `init`: a macho file

![extract-pyload](https://github.com/user-attachments/assets/9592f933-3f49-4ff7-808d-9921adc80461)
![](https://github.com/user-attachments/assets/d42324d0-1849-4195-8009-61afe8cc1262)

- `pretinstall`

`execvp` is executed at startup:

![re-pretinstall-execvp](https://github.com/user-attachments/assets/1af169f9-530c-456e-a3e4-752577e69233)

Dynamic analysis to obtain `execvp` parameters:

![re-preinstall-lldb](https://github.com/user-attachments/assets/443647a6-1873-4292-a0e5-ffff8985dd67)

Looks like it did nothing.

- `init`

It will connect to the C&C server ip at startup:

![re-init-c2](https://github.com/user-attachments/assets/04776a6e-457e-4ed4-9ba3-15a861097d96)

C&C Server IP:
> Here, the port: `0x1f91 => 8081`
- 47.100.65.182:8081
- 10.9.241.235:8081

![re-init-c2-ip](https://github.com/user-attachments/assets/948c3065-7776-444b-b5f2-e71d5ef0dcc5)

Send Cookie:
1. Generate a random number as a cookie.
2. Command data is encrypted using XOR, with the key being 0x42.

![re-init-cookie](https://github.com/user-attachments/assets/2c3d4f40-a6f8-4192-8cb7-74af70999bfc)

Waiting for `interactive`, Receive Command:

![re-init-receive](https://github.com/user-attachments/assets/030ed985-def8-4335-be42-ee17393abd80)

Code 3,8,9: `Execute command line`:

![re-init-389-cmd](https://github.com/user-attachments/assets/0548e7c7-d02f-4426-8363-7bd378cf52b6)

Code 4: `Write file`:

![re-init-4-writefile](https://github.com/user-attachments/assets/10695978-77e9-4739-97f5-696cae17186e)

Code 5: `Download file`:

![re-init-5-downloadfile](https://github.com/user-attachments/assets/1f6759d7-fbeb-4966-b981-b2040ed16e4a)

Code 11: `Ping check`:

![re-init-11-ping](https://github.com/user-attachments/assets/8bfdd3e8-1d99-461b-8d33-553d86b21070)

Because the C2 server was shutdown, it was not possible to determine what shell commands it would deliver for execution:

![c2-server-commands](https://github.com/user-attachments/assets/8b007c90-a5b4-4976-b7b1-b306c9b23e73)

## PartyChaos
**Summary**
- **Malware Sample**: From a phishing site: partychaos[.]space
- **Tag**: `CryptoStealer`

---

**Analysis**

- In the entry function, you can see that after processing the variant string, use the system command to execute it

![static](https://github.com/user-attachments/assets/5b4542db-4ff5-4136-b5de-de896f6c04ca)

- Use lldb debugging to find the executed commands

![lldb](https://github.com/user-attachments/assets/bed30f36-3b67-4b36-a170-a27e4203293f)
